{% extends "base.html" %}

{% block content %}
{% load static %}

<div class="train-cont">
	<div style="width: 50%; border: none" 
		class="train-navbar train-navbar-left"
	>HAE</div>
	<div style="width: 49.6%" 
		class="train-navbar train-navbar-right" onclick="goQVC()"
	>QVC</div>

	<div class="inner-window">

		<div class="slider-container">
		  <input type="range" min="-10" max="1" value="-3" class="slider" id="learningRate">
			<p class="slider-label">Learning rate: 10^(-3)</p>
		</div>

		<div class="slider-container">
		  <input type="range" min="1" max="200" value="50" class="slider" id="epochs">
			<p class="slider-label" id="epochs">Epochs: 50</p>
		</div>

		<div class="slider-container">
		  <input type="range" min="1" max="128" value="32" class="slider" id="batchSize">
			<p class="slider-label">Batch Size: 32</p>
		</div>

		<div class="slider-container">
		  <input type="range" min="10" max="400" value="100" class="slider" id="nSamples">
			<p class="slider-label" id="epochs">Number of Training Data Points: 100</p>
		</div>
		
		<div class="pqc-cont">
			<p class="pqc-cont-text">Parametrized Quantum Circuits</p>
			<div class="pqc-row" style="border-bottom: solid; padding-bottom: 20px">
				<div class="pqc-row-elem" 
					style="
					    font-weight: bold;
					    color: rgba(248, 232, 250, 1);
					    background-color: rgb(40, 61, 94);
					"  onclick="changeSelectedPQC(1)">PQC1</div>
				<div class="pqc-row-elem" onclick="changeSelectedPQC(2)"
				>PQC2</div>
				<div class="pqc-row-elem" onclick="changeSelectedPQC(3)">PQC3</div>
				<div class="pqc-row-elem" onclick="changeSelectedPQC(4)">PQC4</div>
				<div class="pqc-row-elem" onclick="changeSelectedPQC(5)">PQC5</div>
				<div class="pqc-row-elem" onclick="changeSelectedPQC(6)">PQC6</div>
				<div class="pqc-row-elem" onclick="changeSelectedPQC(7)">PQC7</div>
				<div class="pqc-row-elem" onclick="changeSelectedPQC(8)">PQC8</div>
				<div class="pqc-row-elem" onclick="changeSelectedPQC(9)">PQC9</div>
			</div>

			<div style="text-align: left; display: inline-block; width: 50%">
				<img style="width: 100%" src="/static/train_hae/pqc1.png" id="qc_image">
			</div>
			<div style="text-align: center; display: inline-block; width: 49.5%; vertical-align: top;
						padding-top: 60px;
    					border-left: solid; padding-left: 50px">
				<p
					style="
						width: 100%;
						font-size: 1.5vw;
    					font-family: Quicksand;
					"
				>PQC Descriptors</p>

				<div style="text-align: left; font-family: Quicksand;">
					<div style="display: inline-block; width: 49.5%; padding: 20px; padding-top: 0">
						<p style="font-size: 20px">1) Sim Expressivity:</p>
						<p>We use the definition defined in <a href="https://arxiv.org/abs/1905.10876" target="_blank" style="color: rgb(42, 93, 130); font-weight: bold" >this paper</a> as: <br> <img src="/static/train_hae/KL_div.png" style="width: 80%"><br> Whereas KL is the Kullback-Leibler divergence and F is the randomly sampled fidelities. We use 1000 samples to construct the histogram to get the probability density with respect to the fidelities. We sample from the uniform distribution to construct the Haar random states. <br>The resulting histogram for the given PQC: <img src="/static/train_hae/hist/hist_pqc1.png" id="KL_im" style="width: 100%"><br><p id="KL_div" style="font-size: 18px; font-weight:bold">Resulting KL Divergence: </p> </p>
					</div>
					<div style="display: inline-block; width: 49.5%; vertical-align: top">
						<p style="font-size: 20px">2) Entangling Capacity:</p>
						<p>We use the definition defined in <a href="https://arxiv.org/abs/1905.10876" target="_blank" style="color: rgb(42, 93, 130); font-weight: bold" >this paper</a> for entangling capacity, widely known as Meyer-Wallach Measure as: <br> <img src="/static/train_hae/MW.png" style=" width: 80%"><br> Whereas œÅ_k is the density matrix of the Quantum Circuit with the kth qubit traced out. We sample 1000 parameters and average the entangling capacity over the samples. <br> <p id="MW" style="font-size: 18px; font-weight:bold">Resulting Entangling Capacity: </p></p>
					</div>
				</div>

			</div>

			<div style="width:100%; margin-bottom: 50px; border-bottom: solid; padding: 30px;border-top: solid;
    					font-family: Quicksand;" id="startTraining">
				<div class="startTraining" 
				>Start Training</div>
			</div>

			<div style="width:100%;margin-bottom: 50px; border-bottom: solid; padding: 30px;border-top: solid; display: none" id="trainingStarted">
				<div class="trainingStarted"
				>Training Started</div>
			</div>


			<div style="min-height: 700px; display: none" id="training-log-cont">
				<div style="display: inline-block; width: 45%; padding-left: 50px;  vertical-align: top">
					<img id="graph" src="/static/train_hae/loss_plot/blank.png" style="width: 100%">
				</div>
				<div style="display: inline-block; width: 49.5%; text-align: center; vertical-align: top">
					<p style="font-size: 28px; font-family: 'Quicksand'; font-weight: bold" >Training Log:</p>
					<p style="font-size: 23px; font-family: 'Quicksand';" id="log-content"></p>
				</div>
			</div>

		</div>
	</div>

</div>

<script>
	let selectedPQC = 1;
	$("#KL_div")[0].innerText = "Resulting KL Divergence: {{ SIM_expr1 }}";
	$("#MW")[0].innerText = "Resulting Entangling Capacity: {{ MW_measure1 }}";

	SIM_expr = {
		"SIM_expr1": "{{ SIM_expr1 }}",
		"SIM_expr2": "{{ SIM_expr2 }}",
		"SIM_expr3": "{{ SIM_expr3 }}",
		"SIM_expr4": "{{ SIM_expr4 }}",
		"SIM_expr5": "{{ SIM_expr5 }}",
		"SIM_expr6": "{{ SIM_expr6 }}",
		"SIM_expr7": "{{ SIM_expr7 }}",
		"SIM_expr8": "{{ SIM_expr8 }}",
		"SIM_expr9": "{{ SIM_expr9 }}",
	}

	MW_measure = {
		"MW_measure1": "{{ MW_measure1 }}",
		"MW_measure2": "{{ MW_measure2 }}",
		"MW_measure3": "{{ MW_measure3 }}",
		"MW_measure4": "{{ MW_measure4}}",
		"MW_measure5": "{{ MW_measure5 }}",
		"MW_measure6": "{{ MW_measure6 }}",
		"MW_measure7": "{{ MW_measure7 }}",
		"MW_measure8": "{{ MW_measure8 }}",
		"MW_measure9": "{{ MW_measure9 }}",
	}

	const learningRate = document.getElementById('learningRate');
	learningRate.addEventListener('change', updateValueLR);
	function updateValueLR(e) {
	  document.getElementsByClassName('slider-label')[0].innerText = "Learning rate: 10^(" + e.target.value + ")";
	}
	const epochs = document.getElementById('epochs');
	epochs.addEventListener('change', updateValueE);
	function updateValueE(e) {
	  document.getElementsByClassName('slider-label')[1].innerText = "Epochs: " + e.target.value;
	}
	const batchSize = document.getElementById('batchSize');
	batchSize.addEventListener('change', updateValueBS);
	function updateValueBS(e) {
	  document.getElementsByClassName('slider-label')[2].innerText = "Batch Size: " + e.target.value;
	}
	const nSamples = document.getElementById('nSamples');
	nSamples.addEventListener('change', updateValueNS);
	function updateValueNS(e) {
	  document.getElementsByClassName('slider-label')[3].innerText = "Number of Training Data Points: " + e.target.value;
	}


	function goQVC() {
		window.location.href='/train/qvc/';
	}

	function hoverPQC(pqc_el) {
		pqc_el.style.fontWeight = "bold";
		pqc_el.style.color = "rgba(248, 232, 250, 1)";
		pqc_el.style.backgroundColor = "rgb(40, 61, 94)";
	}

	function unHoverPQC(pqc_el) {
		pqc_el.style.fontWeight = "normal";
		pqc_el.style.color = "rgb(40, 61, 94)";
		pqc_el.style.backgroundColor = "rgba(248, 232, 250, 1)";
	}

	function handleMouseOver(e) {hoverPQC(e.target);}
	function handleMouseOut (e) {unHoverPQC(e.target);}

	function changeSelectedPQC(pqc) {
		const old_pqc = document.getElementsByClassName("pqc-row-elem")[selectedPQC-1]
		const pqc_el = document.getElementsByClassName("pqc-row-elem")[pqc-1];

		old_pqc.addEventListener("mouseover", handleMouseOver);
		old_pqc.addEventListener("mouseout", handleMouseOut);

		pqc_el.removeEventListener("mouseover", handleMouseOver);
		pqc_el.removeEventListener("mouseout", handleMouseOut);

		hoverPQC(pqc_el);
		unHoverPQC(old_pqc);

		selectedPQC = pqc;

		const imgElem = document.getElementById("qc_image");
		imgElem.src = "/static/train_hae/pqc" + pqc + ".png";

		$("#KL_im")[0].src = "/static/train_hae/hist/hist_pqc" + selectedPQC + ".png"
		$("#KL_div")[0].innerText = "Resulting KL Divergence: " + SIM_expr["SIM_expr" + selectedPQC];
		$("#MW")[0].innerText = "Resulting Entangling Capacity: " + MW_measure["MW_measure" + selectedPQC];

	}


	let success = false;
	function checkStatus(jobId) {
				$.ajax({
					url: "/train/check-training?job_id=" + jobId ,
				}).done((response) => {
					loss_string = response["loss_string"];
					loss_list = loss_string.split(";");
					console.log(loss_list);
					$("#graph")[0].src = "/static/train_hae/loss_plot/" + response["id"] + "_" + response["epoch"] + ".png";
					let innerHTML = "Training Started.<br>Data points in Data set: " + response["n_samples"] + "<br>Epochs: " + response["epochs"] + "<br>";

					for (let i=0;i<loss_list.length-1;i++) {
						innerHTML = innerHTML + "-> Epoch[" + (i+1) + "/"+ response["epochs"] +"]: "+ loss_list[i] +" <br>"
					}

					$("#log-content")[0].innerHTML = innerHTML,
					success = response["status"] == "completed";
				});
	}

	$('#startTraining').on("click", () => {
		$.ajax({
			url: "/train/start-training?learningRate=" + learningRate.value + "&epochs=" + epochs.value + "&batchSize=" + batchSize.value + "&nSamples=" + nSamples.value + "&pqc=" + selectedPQC + "&model=HAE" ,

		}).done((response) => {
		  	console.log("Traning Started!");
		  	$('#startTraining')[0].style.display = "none";
		  	$('#trainingStarted')[0].style.display = "block";
		  	$("#training-log-cont")[0].style.display = "block";
		  	$("#log-content")[0].innerHTML = "Training Started.<br>Data points in Data set: " + nSamples.value + "<br>Epochs: " + epochs.value + "<br>"

		  	const checkInterval = setInterval(() => {
		  		checkStatus(response);

				console.log(success)
		  		if (success) {
		  			clearInterval(checkInterval);
		  			// TODO: Display Training Complete button
		  		};
		  	} ,5000);

		  	

		});
	});

	// TODO: Check if theres any pending jobs


</script>
{% endblock %}